---
layout: post
title: Run tracker
subtitle: Building a web-app for tracking and visualising exercise data
gh-repo: seallard/run-tracker
tags: [javascript]
comments: false
---

I want to create a web app which gamifies running. It should collect and visualise exercise data such as heart rate, distance, pace etc. The front end will be written with React and the backend with Node/Express.

<a href="url"><img src="/assets/img/runner_app.svg"></a>

I've never done a project in Javascript previously, so there is loads of new things to learn.
Based on some blog articles [[1](https://softwareontheroad.com/ideal-nodejs-project-structure/), [2](https://medium.com/codebase/structure-of-a-nodejs-api-project-cdecb46ef3f8)], I use the following project structure:

```bash
├── backend
│   ├── src
│   │   ├── api
│   │   │   ├── middlewares
│   │   │   └── routes
│   │   ├── models
│   │   ├── services
│   │   └── subscribers
│   └── tests
└── frontend
```
The service layer contains all of the business logic. I will try to use the pub/sub pattern to decouple the code and maintain the single responsibility principle.

## Building the backend
Data from my heart rate monitor can be accessed through the [Polar API](https://www.polar.com/accesslink-api/#polar-accesslink-api). The backend should retrieve and store data from the Polar API. The backend should also expose an API for retrieving the data.

### Consuming the Polar API
Lets create a service consuming the Polar API with the Axios HTTP client library.

#### Authorization
The Polar API uses [OAuth2](https://seallard.dev/2020-12-30-oauth/) to enable users to share access to their data. Users authorize the app via a Polar server, giving the app an authorization code which can be swapped for an access token.
#### **`polar.js`**
```javascript
const getUserAccessToken = (authorizationCode) => {
  const tokenUrl = 'https://polarremote.com/v2/oauth2/token';
  const data = {
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: process.env.REDIRECT,
  };
  const config = basicAuthenticationHeaders();
  const request = axios.post(tokenUrl, qs.stringify(data), config);
  return request.then((response) => response.data);
};
```
The issued token is valid for 15 years and is needed to access the data of the user, so it should be stored in the database. Maybe by emitting a ```createdAccessToken```-event.

#### Registering a user
To be able to access a users data, the id the app uses for the user needs to be registered. For some reason, the content type has to be XML.
#### **`polar.js`**
```javascript
const registerUser = (userId, accessToken) => {
  const data = `<?xml version="1.0" encoding="UTF-8" ?>
  <register>
    <member-id>${userId}</member-id>
  </register>`;
  const headers = {
    'Content-Type': 'application/xml',
    'Authorization': `Bearer ${accessToken}`,
  };
  const request = axios.post(baseUrl+'v3/users', data, {headers: headers});
  return request.then((response) => response.data);
};
```
The registered users can be deleted as well.
#### **`polar.js`**
```javascript
const deleteUser = (accessToken, userId) => {
  const headers = {
    'Authorization': `Bearer ${accessToken}`,
  };
  axios.delete(baseUrl+`v3/users/${userId}`, {headers: headers});
};
```

#### Webhooks
Instead of polling the Polar API for each user, it is possible to register a webhook which notifies the app whenever a user completes an exercise session.
#### **`polar.js`**
```javascript
const createWebhook = () => {
  const data = {
    'events': [
      'EXERCISE',
    ],
    'url': process.env.WEBHOOK_URL,
  };
  const basicAuth = getEncodedCredentials();
  const config = {
    headers: {
      'Authorization': `Basic ${basicAuth}`,
    },
  };
  const request = axios.post(baseUrl+'v3/webhooks', data, config);
  return request.then((response) => response.data);
};
```
The app must reply with status code 200 to verify that it is listening. Whenever a registered user completes an exercise session, the following data is posted:
```json
{
   "event": "EXERCISE",
   "user_id": 475,
   "entity_id": "aQlC83",
   "timestamp": "2018-05-15T14:22:24Z",
   "url": "https://www.polaraccesslink.com/v3/exercises/aQlC83"
}
```
When such a post request is received, an ```exerciseReceived```-event could be emitted.

#### Fetching user data
The Polar API uses a transactional model for fetching user data. So to retrive data, one has to create a transaction, retrieve data with the transaction and then commit it.

#### **`polar.js`**
```javascript
const createTransaction = (userId, accessToken) => {
  const config = tokenAuthenticationHeaders(accessToken);
  const url = baseUrl+`v3/users/${userId}/exercise-transactions`;
  const request = axios.post(url, null, config);
  return request.then((response) => response);
};
```
If there is new training data, a transaction is created and its id is returned. The id is used to retrieve the users data. After retrieving it, it is expected that the transaction is committed.
#### **`polar.js`**
```javascript
const commitTransaction = (userId, accessToken, transactionId) => {
  const config = tokenAuthenticationHeaders(accessToken);
  const end = `v3/users/${userId}/exercise-transactions/${transactionId}`;
  const request = axios.put(baseUrl+end, null, config);
  return request.then((response) => response);
};
```
Once a transaction has been created, different [types of data samples](https://www.polar.com/accesslink-api/?javascript--nodejs#exercise-sample-types) can be retrieved.
#### **`polar.js`**
```javascript
const getDataSamples = (userId, transactionId, exerciseId, sampleType, accessToken) => {
  const config = tokenAuthenticationHeaders(accessToken);
  const start = `v3/users/${userId}/exercise-transactions/${transactionId}`;
  const end = `/exercises/${exerciseId}/samples/${sampleType}`;
  const request = axios.get(baseUrl+start+end, config);
  return request.then((response) => response.data);
};
```

### Setting up the database


## Building the front end


# Resources
- [Full stack open MOOC](https://fullstackopen.com/en/)
- [Express.Router SO](https://stackoverflow.com/questions/28305120/differences-between-express-router-and-app-get)
- [MERN app structure SO](https://stackoverflow.com/questions/51126472/how-to-organise-file-structure-of-backend-and-frontend-in-mern/51128385#51128385)
- [What are webhooks?](https://codeburst.io/whats-a-webhook-1827b07a3ffa)