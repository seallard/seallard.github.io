---
layout: post
title: Run tracker
subtitle: Building a web-app for tracking and visualising exercise data
gh-repo: seallard/run-tracker
tags: [javascript]
comments: false
---

I want to create a web app which gamifies running. It should collect and visualise exercise data such as heart rate, distance, pace etc. The front end will be written with React and the backend with Node/Express.

<a href="url"><img src="/assets/img/runner_app.svg"></a>

I've never done a project in Javascript previously, so there is loads of new things to learn.
Based on some blog articles [[1](https://softwareontheroad.com/ideal-nodejs-project-structure/), [2](https://medium.com/codebase/structure-of-a-nodejs-api-project-cdecb46ef3f8)], I use the following project structure:

```bash
├── backend
│   ├── src
│   │   ├── api
│   │   │   ├── middlewares
│   │   │   └── routes
│   │   ├── models
│   │   ├── services
│   │   └── subscribers
│   └── tests
└── frontend
```
The service layer contains all of the business logic. I will try to use the pub/sub pattern to maintain the single responsibility principle. So, for example, when a user signs up a signup-event will be emitted which all subscribed handlers can deal with (maybe I want to send an email verification, store the user in a database etc.).

## Building the backend
Data from my heart rate monitor can be accessed through the [Polar API](https://www.polar.com/accesslink-api/#polar-accesslink-api). The backend should retrieve data from the Polar API and write it to a database. The backend should also expose an API for retrieving the data.

### Consuming the Polar API
Lets create a service consuming the Polar API with the Axios HTTP client library.

#### Authorization
The Polar API uses [OAuth2](https://seallard.dev/2020-12-30-oauth/) to enable users to share access to their data. Users authorize my app via a Polar server, giving me an authorization code which can be swapped for an access token.

```javascript
const getUserAccessToken = (authorizationCode) => {
  const tokenUrl = 'https://polarremote.com/v2/oauth2/token';
  const data = {
    grant_type: 'authorization_code',
    code: authorizationCode,
    redirect_uri: process.env.REDIRECT,
  };
  const config = basicAuthenticationHeaders();
  const request = axios.post(tokenUrl, qs.stringify(data), config);
  return request.then((response) => response.data);
};
```
The issued token is valid for 15 years, so I will need to store it in the database. Maybe by emitting a createdAccessToken-event.

#### Registering a user
To be able to access a users data, the id my app uses for the user needs to be registered.

```javascript
const registerUser = (userId, accessToken) => {
  const data = {
    'member-id': userId,
  };
  const config = tokenAuthenticationHeaders(accessToken);
  const request = axios.post(baseUrl+'/v3/users', data, config);
  return request.then((response) => response.data);
};
```
There is an endpoint for deleting the user as well, but I'll leave it out for brevity.

#### Webhooks
Instead of polling the Polar API for each user, it is possible to create a webhook which sends an event to my app whenever a user completes an exercise session.

### Setting up the database


## Building the front end


# Resources
- [Full stack open MOOC](https://fullstackopen.com/en/)
- [Express.Router SO](https://stackoverflow.com/questions/28305120/differences-between-express-router-and-app-get)
- [MERN app structure SO](https://stackoverflow.com/questions/51126472/how-to-organise-file-structure-of-backend-and-frontend-in-mern/51128385#51128385)
- [What are webhooks?](https://codeburst.io/whats-a-webhook-1827b07a3ffa)